---
title: "MLS Player and Club Analytics"
output:
  flexdashboard::flex_dashboard:
    theme: united
    
runtime: shiny

---

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(dplyr)
library(ggplot2)
library(ggrepel)
library(googlesheets)
library(reshape)
library(lubridate)
library(ezmisc)
library(nnet)
library(lsmeans)
library(msm)
library(grid)
library(d3heatmap)
library(tidyverse)
library(data.table)
library(DT)
Soccer_data <- read.csv("CopyOfSoccer_data_8_4_17.csv") ###replace with DF
Soccer_data <- Soccer_data[c(2:22)]
Soccer_data$xGoals_pShot <- round(Soccer_data$xGoals/Soccer_data$Shots,2)
Soccer_data$xA_pKP <- round(Soccer_data$xAssist/Soccer_data$Key_Passes,2)
round(Soccer_data$Shots_p_96, 2)
round(Soccer_data$xGoalp96, 2)
round(Soccer_data$KP_p96, 2)
round(Soccer_data$xAss_p96, 2)
round(Soccer_data$xGoals_pShot, 2)
round(Soccer_data$xA_pKP, 2)
Soccer_data$UnAstShot_perct <- gsub("%", "", paste(Soccer_data$UnAstShot_perct) )
Soccer_data$Touch_perct <- gsub("%", "", paste(Soccer_data$Touch_perct) )
Soccer_data$UnAstShot_perct <- as.numeric(as.character(Soccer_data$UnAstShot_perct))
Soccer_data$Touch_perct <- as.numeric(as.character(Soccer_data$Touch_perct))
Soccer_data$Club <- ifelse(Soccer_data$Club=="DC", "DCU", as.character(Soccer_data$Club))
Soccer_data$Club <- ifelse(Soccer_data$Club=="Dal", "FCD", as.character(Soccer_data$Club))
Soccer_data$Club <- ifelse(Soccer_data$Club=="DAL", "FCD", as.character(Soccer_data$Club))
row.names(Soccer_data) <- NULL

Passing <- read.csv("Copyofpassing_data_8_4_17.csv") ###replace with passing dataframe
```

The data for this site comes from the great work by the group at American Soccer Analysis http://www.americansocceranalysis.com/

Player Analytics Tables
===============================

Column {sidebar}
--------------------

### Filter Data
Filter By Year and Select the Stats to View
```{r, echo=FALSE}
selectInput("Year", "Year",
            choices = Soccer_data$Year, selected = "2017", multiple = TRUE)

checkboxGroupInput("stat", "Stat", choices = names(Soccer_data), selected = names(Soccer_data), inline=TRUE)

```

Column {data-width=2000} 
---------------

###Player Stat Tracker
You can search by player or club then sort by the variable you want to look at.
```{r, echo=FALSE, fig.height=20, fig.height=40}
renderDataTable({
  filtered <-
  Soccer_data %>%
  filter(Year %in% input$Year) 
    datatable(filtered[, c(input$stat)], extensions= c('Scroller', 'FixedColumns'), options = list(
scrollY = 400, paging = TRUE, scrollX = TRUE, fixedColumns = list(leftColumns= 4))) %>%  formatStyle('G_xGdiff', background =  styleColorBar(range(filtered$G_xGdiff), 'lightblue'),  backgroundSize = '95% 50%', backgroundRepeat = 'no-repeat',
backgroundPosition = 'center') %>%  formatStyle('Key_Passes', background =  styleColorBar(range(filtered$Key_Passes), 'lightblue'),  backgroundSize = '95% 50%', backgroundRepeat = 'no-repeat',
backgroundPosition = 'center')  %>%  formatStyle('xGoals', background =  styleColorBar(range(filtered$xGoals), 'green'),  backgroundSize = '95% 50%', backgroundRepeat = 'no-repeat',
backgroundPosition = 'center') %>%  formatStyle('xGoals_pShot', background =  styleColorBar(range(filtered$xGoals_pShot, na.rm=T), 'green'),  backgroundSize = '95% 60%', backgroundRepeat = 'no-repeat',
backgroundPosition = 'center') 
    } )
```

Player Analytics Visuals
===============================

Column {data-width=200}
--------------------

### Filter Data
Filter By Year and Select the Stats to View
```{r, echo=FALSE, fig.width = 5}
selectInput("Year2", "Year",
            choices = Soccer_data$Year, multiple = TRUE)

selectInput("player", "Player(s)", choices = Soccer_data$Name, multiple=TRUE)

```

Glossary: xGoals = expected goals; G_xGdiff = Difference between actual goals and expected goals positive is better than negative; Key_Passess = passes that lead directly to a shot; xAssist = expected assist (proportion that goal should have occured based on the pass); A_xAdiff = difference between assists and expected assists; Goal.Ass = sum of goals and assists; xGo_xAs = sum of expected goals and expected assists; Shots_p_96 = shots per 96 minutes (average MLS game); xGoalp96 = expected goals per 96 minutes; KP_p96 = key passes per 96 minutes; xAss_p96 = expected assists per 96 minutes; xG.xA_p96 = sum of expected goals plus expected assists per 96 minutes; xGoals_pShot = expected goals per shot; xA_pKP = expected assists per key pass

Column {.tabset} 
---------------

###Player Stat Tracker
You can search by player or club then sort by the variable you want to look at.
```{r, echo=FALSE, fig.width=5, fig.height=10}
renderPlot({
  filtered <-
  Soccer_data %>%
  filter(Year %in% input$Year2,
         Name %in% input$player)
    filtered2 <- filtered[, c("Name", "Minutes", "Shots", "Goals", "xGoals", "G_xGdiff", "Key_Passes", "Assist", "xAssist", "A_xAdiff", "Goal.Ass.1", "xGo_xAs", "xGoals_pShot", "xA_pKP")]
  
ez.radarmap(filtered2, "Name", stats="mean", lwd=1, angle=0, fontsize=0.9, facet=T, facetfontsize = 1, color=id, linetype=NULL)
})
```


###Player Stat Tracker per 96 minutes

```{r, echo=FALSE, fig.width=5, fig.height=10}
renderPlot({
  filtered <-
  Soccer_data %>%
  filter(Year %in% input$Year2,
         Name %in% input$player)
    filtered3 <- filtered[, c("Name", "Shots_p_96", "xGoalp96", "KP_p96", "xAss_p96", "xG.xA_p96.1")]
  
ez.radarmap(filtered3, "Name", stats="mean", lwd=1, angle=0, fontsize=0.9, facet=T, facetfontsize = 1, color=id, linetype=NULL)
})
```

Player Impact
===============================

Column {data-width=200}
-----------------------

### Filter Data
Use the sliders to filter the data
```{r, echo=FALSE, fig.width = 5}
sliderInput("Shots", "Shots", 20, 200, 50, step = 10)

sliderInput("KPs", "Key Passes", 10, 110, 20, step =10)

sliderInput("goals", "Goals", 5, 25, 10, step = 5)

```

Glossary: xGoals = expected goals; G_xGdiff = Difference between actual goals and expected goals positive is better than negative; Key_Passess = passes that lead directly to a shot; xAssist = expected assist (proportion that goal should have occured based on the pass); A_xAdiff = difference between assists and expected assists; Goal.Ass = sum of goals and assists; xGo_xAs = sum of expected goals and expected assists; Shots_p_96 = shots per 96 minutes (average MLS game); xGoalp96 = expected goals per 96 minutes; KP_p96 = key passes per 96 minutes; xAss_p96 = expected assists per 96 minutes; xG.xA_p96 = sum of expected goals plus expected assists per 96 minutes; xGoals_pShot = expected goals per shot; xA_pKP = expected assists per key pass


Column {.tabset} 
------------------

###Attacking Specialists

```{r, echo=FALSE, fig.width=4, fig.height=12}
renderPlot({
  filtered_Playmakers <-
  Soccer_data %>%
  filter(Shots > input$Shots,
         Key_Passes > input$KPs,
         Goals > input$goals) %>%
  select(Year:xA_pKP)
    
ggplot(filtered_Playmakers, aes(xGoals_pShot, xA_pKP, label = Name))+geom_point(aes(shape = as.factor(as.character(Year)), colour = Club, size = xGoals), stat="identity" )+ xlab("Expected Goals per Shot")+ ylab("Expected Assists per Key Pass")+geom_label_repel()+scale_shape_discrete(name = "Year")
})

```

###Table

```{r, echo=FALSE, fig.width=5, fig.height=10}
renderDataTable({
  filtered_Playmakers <-
  Soccer_data %>%
  filter(Shots > input$Shots,
         Key_Passes > input$KPs,
         Goals > input$goals) %>%
  select(Year:xA_pKP)
    filtered_Playmakers
}
,options = list(
scrollY = '300px', paging = TRUE, scrollX = TRUE))
```

###Goals versus Goal to expected Goal difference

```{r, echo=FALSE, fig.width=5, fig.height=10}
renderPlot({
  filtered_Playmakers <-
  Soccer_data %>%
  filter(Shots > input$Shots,
         Key_Passes > input$KPs,
         Goals > input$goals) %>%
  select(Year:xA_pKP)
    
ggplot(filtered_Playmakers, aes(Goals, G_xGdiff, label = Name))+geom_rect(data=NULL,aes(xmin=15,xmax=25,ymin=4,ymax=8),
                    fill="lightgreen")+geom_point(aes(shape = as.factor(as.character(Year)), colour = Club, size = Shots), stat="identity" )+ xlab("Goals Scored")+ ylab("Difference in Goals versus expected Goals ")+geom_label_repel()+scale_y_continuous(breaks = c(-6,-4,-2,0,2,4,6,8,10,12))+xlim(5,25)+scale_shape_discrete(name = "Year")
})
```


2017 Club Comparisons
===============================

Column {data-width=150}
-----------------------

### Filter Data

```{r, echo=FALSE, fig.width = 5}

selectInput("Club", "Club", choices = Soccer_data$Club, selected= Soccer_data$Club=="MN")

```

Column {data-width=1200}
-----------------

###Stat Heat Map (Hover over to see the values)

```{r, echo=FALSE, fig.width = 5, fig.height=10}
renderD3heatmap({
  filter_Club <-
    Soccer_data %>%
    filter(Year > 2016,
           Club == input$Club)
   filter_Club2 <- filter_Club[, c("Name", "Minutes", "Shots", "Goals", "xGoals", "G_xGdiff", "Key_Passes", "Assist", "xAssist", "A_xAdiff", "Goal.Ass.1", "xGo_xAs", "xGoals_pShot", "xA_pKP", "Shots_p_96", "xGoalp96", "KP_p96")]
   
  filter_Club3 <- filter_Club2 %>% remove_rownames %>% column_to_rownames(var="Name")
   
  d3heatmap(filter_Club3, scale="column", colors = "YlOrRd", dendrogram = "none", width = 100, cexRow = .8, cexCol = .8)
  
})

```

Column {data-width=500}
-----------------

```{r, echo=FALSE}
renderDataTable({
filter_Club <-
    Soccer_data %>%
    filter(Year > 2016,
           Club == input$Club)
 
  filter_Club[1:15,c("Name", "Minutes", "xGoals", "Key_Passes")]
})
```

Passing Analytics 
=====================================================

Column {.sidebar}
----------------------

### Filter Data

```{r, echo=FALSE, fig.width = 5}

selectInput("Club2", "Club", choices = Passing$Club, selected= Passing$Club[[220]] , multiple = TRUE)

sliderInput("pass", "Passes", 50, 1000, 100, step = 100)

```

Column {.tabset}
--------------------

###Attacking 3rd

```{r, echo=FALSE}
renderPlot({
filter_pass <-
    Passing %>%
    filter(Club %in% input$Club2,
           Att_3rd_Passes > input$pass)
 
  ggplot(filter_pass, aes(Att_3rd_Passes, Att_3rd_xPRCT, colour=Att_3rd_PRCT_diff, shape=Club))+geom_point(size=4)+scale_color_gradient2(name="Percent diff \nin passing accuracy", low="red", mid="yellow", high="green", midpoint= 1.0)+geom_text(aes(label=Name), vjust = -1 )+geom_text(aes(label=Att_3rd_PRCT), vjust=2)+theme_dark()+xlab("# of Passes in Attacking Third")+ylab("Expected Passing Percentage in Attacking Third")
})
```


###Middle 3rd

```{r, echo=FALSE}
renderPlot({
filter_pass_mid <-
    Passing %>%
    filter(Club %in% input$Club2,
           Middle_3rd_Passes > input$pass)
 
  ggplot(filter_pass_mid, aes(Middle_3rd_Passes, Middle_3rd_xPRCT, colour=Middle_3rd_PRCT_diff, shape=Club))+geom_point(size=4)+scale_color_gradient2(name="Percent diff \nin passing accuracy", low="red", mid="yellow", high="green", midpoint= 1.0)+geom_text(aes(label=Name), vjust = -1 )+geom_text(aes(label=Middle_3rd_PRCT), vjust=2)+theme_dark()+xlab("# of Passes in Middle Third")+ylab("Expected Passing Percentage in Middle Third")
})
```

###Defensive 3rd

```{r, echo=FALSE}
renderPlot({
filter_pass_def <-
    Passing %>%
    filter(Club %in% input$Club2,
           DEF_3rd_Passes > input$pass)
 
  ggplot(filter_pass_def, aes(DEF_3rd_Passes, DEF_3rd_xPRCT, colour=DEF_3rd_PRCT_diff, shape=Club))+geom_point(size=4)+scale_color_gradient2(name="Percent diff \nin passing accuracy", low="red", mid="yellow", high="green", midpoint= 0.0)+geom_text(aes(label=Name), vjust = -1 )+geom_text(aes(label=DEF_3rd_PRCT), vjust=2)+theme_dark()+xlab("# of Passes in Defensive Third")+ylab("Expected Passing Percentage in Defensive Third")
})
```